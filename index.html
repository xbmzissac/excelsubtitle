<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字幕语义合并（含 DeepSeek API）</title>
    <style>
        * {
            font-family: '微软雅黑', sans-serif;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background-color: #eee;
            border-radius: 2px;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 100%;
            background-color: #4a90e2;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .button {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1.5rem;
        }

        .result-link {
            color: #4a90e2;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 2rem;">字幕语义合并工具（含 DeepSeek API）</h1>

        <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
        <label for="fileInput" class="button">选择本地 Excel 文件</label>

        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <button id="processButton" class="button" disabled>开始处理文件</button>

        <div id="result" style="display: none; margin-top: 1.5rem;">
            <p>处理完成！点击下方链接下载新表格：</p>
            <a id="downloadLink" class="result-link" download="合并后字幕表.xlsx">下载合并后的文件</a>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const result = document.getElementById('result');
        const downloadLink = document.getElementById('downloadLink');

        // DeepSeek API 相关配置
        const DEEPSEEK_API_URL = 'YOUR_DEEPSEEK_API_URL';
        const DEEPSEEK_API_KEY = 'YOUR_DEEPSEEK_API_KEY';

        // 文件选择处理
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            processButton.disabled = false;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            // 读取 Excel 文件
            const workbook = await readExcelFile(file);
            const sheetName = workbook.SheetNames[0];
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

            processButton.addEventListener('click', async () => {
                processButton.disabled = true;
                progressBar.style.width = '0%';

                // 数据处理
                const mergedData = await processSubtitles(sheetData);

                // 生成新 Excel
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.sheet_add_aoa(newWorkbook, [sheetData[0], ...mergedData], { sheet: '字幕' });
                const excelBuffer = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'arraybuffer' });

                // 创建下载链接
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                downloadLink.href = URL.createObjectURL(blob);
                result.style.display = 'block';
                progressContainer.style.display = 'none';
                processButton.disabled = false;
            });
        });

        // 读取 Excel 文件
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    resolve(workbook);
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 使用 DeepSeek API 判断句子是否结束
        async function isSentenceEnd(text) {
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sk-3c45ea45fb0648aeac327250131ebd51}`
                    },
                    body: JSON.stringify({ text: text })
                });
                const result = await response.json();
                return result.is_end;
            } catch (error) {
                console.error('调用 DeepSeek API 出错:', error);
                return false;
            }
        }

        // 处理字幕数据
        async function processSubtitles(data) {
            const headers = data[0];
            const rows = data.slice(1);
            const merged = [];
            let currentEpisode = null;
            let currentText = [];
            let currentTime = [];
            let currentTrans = null;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const episode = row[headers.indexOf('episode')];
                const txt = row[headers.indexOf('txt')].trim();
                const trans = row[headers.indexOf('trans')];
                const time = row[headers.indexOf('time')];

                if (currentEpisode === null || episode!== currentEpisode || await isSentenceEnd(txt)) {
                    if (currentText.length > 0) {
                        merged.push([
                            currentEpisode,
                            currentText.join(' '),
                            currentTrans || trans,
                            currentText.join(' ').length,
                            currentTime.join('|')
                        ]);
                    }
                    currentEpisode = episode;
                    currentText = [txt];
                    currentTime = [time];
                    currentTrans = trans;
                } else {
                    currentText.push(txt);
                    currentTime.push(time);
                    if (!currentTrans && trans) {
                        currentTrans = trans;
                    }
                }
            }

            if (currentText.length > 0) {
                merged.push([
                    currentEpisode,
                    currentText.join(' '),
                    currentTrans,
                    currentText.join(' ').length,
                    currentTime.join('|')
                ]);
            }

            return merged;
        }
    </script>
</body>

</html>    